<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Template Drag-and-Drop Editor</title>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Ubuntu', Arial, sans-serif; background: #f4f8ff; margin: 0; padding: 0; }
    .container { max-width: 1200px; margin: 32px auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.10); padding: 32px; }
    h1 { color: #001489; text-align: center; }
    .templates-list, .bace-preview { min-height: 100px; padding: 16px; border-radius: 8px; margin-bottom: 24px; }
    .templates-list { background: #f9f9f9; border: 2px dashed #003ab8; display: flex; flex-wrap: wrap; gap: 16px; }
    .template-item { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 18px; cursor: grab; min-width: 180px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: box-shadow 0.2s; }
    .template-item:active { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
    .bace-preview { background: #f5faff; border: 2px solid #FFCD00; min-height: 200px; }
    .block { background: #fff; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 12px; padding: 16px; position: relative; cursor: move; }
    .block .edit-btn, .block .delete-btn { position: absolute; top: 8px; font-size: 0.9em; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; }
    .block .edit-btn { right: 48px; background: #003ab8; color: #fff; }
    .block .delete-btn { right: 8px; background: #BA0C2F; color: #fff; }
    .block.editing { border: 2px solid #003ab8; background: #eef6ff; }
    .save-btn { background: #003ab8; color: #fff; font-weight: 700; padding: 12px 32px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; display: block; margin: 32px auto 0 auto; }
    textarea.block-edit { width: 100%; height: 120px; font-size: 1em; font-family: monospace; border-radius: 6px; border: 1px solid #bbb; margin-top: 8px; }
    .drag-over { border: 2px dashed #28a745 !important; background: #eaffea !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Drag & Drop Template Editor</h1>
    <div class="css-editor" id="formattingSection">
      <h2 style="margin-top:0;color:#001489;">Global Formatting</h2>
      <label>Primary Color: <input type="color" id="primaryColor" value="#001489"></label>
      <label>Accent Color: <input type="color" id="accentColor" value="#FFCD00"></label>
      <label>Font Family:
        <select id="fontFamily">
          <option value="Ubuntu,Arial,sans-serif">Ubuntu, Arial, sans-serif</option>
          <option value="Arial,sans-serif">Arial, sans-serif</option>
          <option value="Georgia,serif">Georgia, serif</option>
        </select>
      </label>
      <button id="applyFormatting" style="margin-left:16px;background:#003ab8;color:#fff;font-weight:700;padding:6px 18px;border:none;border-radius:6px;cursor:pointer;">Apply</button>
    </div>
    <h2>Available Templates</h2>
    <div class="templates-list" id="templatesList"></div>
    <div id="templatePreviewPopup" style="display:none;position:absolute;z-index:1000;background:#fff;border:2px solid #003ab8;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.12);padding:18px;max-width:420px;min-width:220px;"></div>
    <h2>Bace.html Preview (Drag templates here)</h2>
    <div class="bace-preview" id="bacePreview"></div>
    <button class="save-btn" id="saveBtn">Export to Bace.html</button>
    <!-- Modal for editing block info -->
    <div id="editModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2000;align-items:center;justify-content:center;">
      <div id="editModalContent" style="background:#fff;padding:32px 24px;border-radius:12px;max-width:420px;width:90vw;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;">
        <h2 id="editModalTitle" style="margin-top:0;color:#003ab8;font-size:1.2em;"></h2>
        <form id="editForm">
          <div id="editFormFields"></div>
          <div style="margin-top:18px;text-align:right;">
            <button type="button" id="editCancelBtn" style="margin-right:12px;background:#eee;color:#003ab8;font-weight:600;padding:6px 18px;border:none;border-radius:6px;cursor:pointer;">Cancel</button>
            <button type="submit" id="editSaveBtn" style="background:#003ab8;color:#fff;font-weight:700;padding:6px 18px;border:none;border-radius:6px;cursor:pointer;">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
        // Quick meeting block generator
        function parseMeetingText(text) {
          // Improved parser for labeled meeting format
          const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
          let data = {
            title: '',
            subtitle: '',
            location: '',
            uod: '',
            details: '',
            cadets: '',
            primary: ''
          };
          let current = '';
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            let match;
            if ((match = line.match(/^\[Location\]\s*(.*)$/i))) { data.location = match[1]; continue; }
            if ((match = line.match(/^UOD:\s*(.*)$/i))) { data.uod = match[1]; continue; }
            if ((match = line.match(/^Details:\s*(.*)$/i))) { data.details = match[1]; continue; }
            if ((match = line.match(/^Cadets:\s*(.*)$/i))) { data.cadets = match[1]; continue; }
            if ((match = line.match(/^Primary AM:\s*(.*)$/i))) { data.primary = match[1]; continue; }
            if ((match = line.match(/^\[UOD\]\s*(.*)$/i))) { data.uod = match[1]; continue; }
            if ((match = line.match(/^\[Details\]\s*(.*)$/i))) { data.details = match[1]; continue; }
            if ((match = line.match(/^\[Cadets\]\s*(.*)$/i))) { data.cadets = match[1]; continue; }
            if ((match = line.match(/^\[Primary AM\]\s*(.*)$/i))) { data.primary = match[1]; continue; }
            if (!data.title) { data.title = line; continue; }
            if (!data.subtitle) { data.subtitle = line; continue; }
          }
          let html = '<div style="padding:22px 28px;background:#fafdff;border-radius:12px;border:2px solid #003ab8;box-shadow:0 4px 16px rgba(0,0,0,0.10);margin-bottom:14px;">';
          if (data.title) html += `<div style='font-size:1.3em;font-weight:800;color:#003ab8;margin-bottom:10px;letter-spacing:0.5px;'>${data.title}</div>`;
          if (data.location) html += `<div style='margin-bottom:6px;display:flex;align-items:center;gap:8px;'><span style="font-size:1.1em;">üìç</span><span style='color:#003ab8;font-weight:600;'>[Location]</span> <span style='color:#222;'>${data.location}</span></div>`;
          if (data.uod) html += `<div style='margin-bottom:6px;display:flex;align-items:center;gap:8px;'><span style="font-size:1.1em;">üéΩ</span><span style='color:#FFCD00;font-weight:700;'>[UOD]</span> <span style='color:#444;'>${data.uod}</span></div>`;
          if (data.details) html += `<div style='margin-bottom:6px;display:flex;align-items:center;gap:8px;'><span style="font-size:1.1em;">üìù</span><span style='color:#003ab8;font-weight:600;'>[Details]</span> <span style='color:#333;'>${data.details}</span></div>`;
          if (data.cadets) html += `<div style='margin-bottom:6px;display:flex;align-items:center;gap:8px;'><span style="font-size:1.1em;">üë§</span><span style='color:#003ab8;font-weight:600;'>[Cadets]</span> <span style='color:#003ab8;'>${data.cadets}</span></div>`;
          if (data.primary) html += `<div style='margin-bottom:6px;display:flex;align-items:center;gap:8px;'><span style="font-size:1.1em;">‚≠ê</span><span style='color:#003ab8;font-weight:600;'>[Primary AM]</span> <span style='color:#003ab8;'>${data.primary}</span></div>`;
          html += '</div>';
          return html;
        }

        // Paste handler for meeting info
        document.addEventListener('paste', function(e) {
          const text = (e.clipboardData || window.clipboardData).getData('text');
          // Detect meeting format (starts with 'Meeting #')
          if (/^Meeting #/i.test(text)) {
            e.preventDefault();
            addBlock(parseMeetingText(text), 'Meeting Card');
          }
        });
    // List of templates (update if you add more)
    const templates = [
      { name: 'Meeting Card', file: 'templates/template3.html' },
      { name: 'No Meeting Highlight', file: 'templates/template4.html' },
      { name: 'General Info Card', file: 'templates/template5.html' },
      { name: 'Opportunity Card', file: 'templates/template6.html' },
      { name: 'Wing Announcement Card', file: 'templates/template7.html' },
      { name: 'Open Signups', file: 'templates/template-signup.html' },
      { name: 'Divider: Upcoming Squadron Meetings', file: 'templates/template-divider-meetings.html' },
      { name: 'Divider: General Squadron Information', file: 'templates/template-divider-general.html' },
      { name: 'Divider: Ongoing Opportunities', file: 'templates/template-divider-opportunities.html' },
      { name: 'Divider: Wing & Higher Command Announcements', file: 'templates/template-divider-wing.html' },
      { name: 'Divider: Footer', file: 'templates/template-divider-footer.html' }
    ];
    // Load template HTML via fetch
    async function fetchTemplate(file) {
      const res = await fetch(file);
      return await res.text();
    }
    // Render template list
    const templatesList = document.getElementById('templatesList');
    const templatePreviewPopup = document.getElementById('templatePreviewPopup');
    templates.forEach((tpl, idx) => {
      const div = document.createElement('div');
      div.className = 'template-item';
      // Preview on hover
      div.addEventListener('mouseenter', async e => {
        const html = await fetchTemplate(tpl.file);
        templatePreviewPopup.innerHTML = `<div style='font-weight:600;color:#003ab8;margin-bottom:8px;'>${tpl.name}</div>` + html;
        templatePreviewPopup.style.display = 'block';
        const rect = div.getBoundingClientRect();
        templatePreviewPopup.style.top = (window.scrollY + rect.bottom + 8) + 'px';
        templatePreviewPopup.style.left = (window.scrollX + rect.left) + 'px';
      });
      div.addEventListener('mouseleave', e => {
        templatePreviewPopup.style.display = 'none';
      });
      // Drag to add block
      div.draggable = true;
      div.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/template', tpl.file);
        div.classList.add('dragging');
      });
      div.addEventListener('dragend', e => {
        div.classList.remove('dragging');
      });
      // Click to add block
      div.addEventListener('click', async () => {
        const html = await fetchTemplate(tpl.file);
        addBlock(html, tpl.name);
      });
      templatesList.appendChild(div);
      div.textContent = tpl.name;
    });

    // Add block to preview
    const bacePreview = document.getElementById('bacePreview');
    function addBlock(html, name, data) {
      const block = document.createElement('div');
      block.className = 'block';
      block.innerHTML = `<span style="font-weight:600;color:#003ab8;">${name}</span><button class="edit-btn">Edit</button><button class="delete-btn">Delete</button><div class="block-content">${html}</div>`;

      // Enable drag-and-drop reorder
      block.draggable = true;
      block.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/block', 'block');
        e.dataTransfer.setData('block-idx', Array.from(bacePreview.children).indexOf(block));
        block.classList.add('dragging');
      });
      block.addEventListener('dragend', e => { block.classList.remove('dragging'); });
      block.addEventListener('dragover', e => { e.preventDefault(); block.classList.add('drag-over'); });
      block.addEventListener('dragleave', e => { block.classList.remove('drag-over'); });
      block.addEventListener('drop', e => {
        e.preventDefault();
        block.classList.remove('drag-over');
        const dragging = document.querySelector('.block.dragging');
        if (dragging && dragging !== block) {
          if (e.offsetY < block.offsetHeight / 2) {
            bacePreview.insertBefore(dragging, block);
          } else {
            bacePreview.insertBefore(dragging, block.nextSibling);
          }
        }
      });

      // Delete button
      block.querySelector('.delete-btn').onclick = function() {
        block.remove();
      };

      // Edit button: open modal form
      block.querySelector('.edit-btn').onclick = function() {
        openEditModal(block, name);
      };

      bacePreview.appendChild(block);
    }

    // Modal editing logic
    const editModal = document.getElementById('editModal');
    const editModalTitle = document.getElementById('editModalTitle');
    const editForm = document.getElementById('editForm');
    const editFormFields = document.getElementById('editFormFields');
    // Cancel button event must be set after form is rendered

    function openEditModal(block, name) {
      // Parse current block content for fields
      const contentDiv = block.querySelector('.block-content');
      let fields = [];
      if (name === 'Meeting Card') {
        // Parse fields from HTML
        const html = contentDiv.innerHTML;
        // Use regex to extract values
        const title = (html.match(/font-weight:700[^>]*>([^<]*)<\//) || [,''])[1];
        const location = (html.match(/\[Location\][^>]*>([^<]*)<\//) || [,''])[1];
        const uod = (html.match(/\[UOD\][^>]*>([^<]*)<\//) || [,''])[1];
        const details = (html.match(/\[Details\][^>]*>([^<]*)<\//) || [,''])[1];
        const cadets = (html.match(/\[Cadets\][^>]*>([^<]*)<\//) || [,''])[1];
        const primary = (html.match(/\[Primary AM\][^>]*>([^<]*)<\//) || [,''])[1];
        fields = [
          {label: 'Title', name: 'title', value: title},
          {label: '[Location]', name: 'location', value: location},
          {label: '[UOD]', name: 'uod', value: uod},
          {label: '[Details]', name: 'details', value: details},
          {label: '[Cadets]', name: 'cadets', value: cadets},
          {label: '[Primary AM]', name: 'primary', value: primary}
        ];
      } else {
        // Fallback: just edit the HTML
        fields = [
          {label: 'HTML', name: 'html', value: contentDiv.innerHTML}
        ];
      }
      editModalTitle.textContent = `Edit ${name}`;
      editFormFields.innerHTML = '';
      fields.forEach(f => {
        editFormFields.innerHTML += `<label style='display:block;margin:10px 0 4px 0;font-weight:600;'>${f.label}</label><input type='text' name='${f.name}' value="${f.value.replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" style='width:100%;padding:6px 8px;border-radius:5px;border:1px solid #bbb;font-size:1em;'>`;
      });
      editModal.style.display = 'flex';
      // Set cancel button event
      document.getElementById('editCancelBtn').onclick = () => { editModal.style.display = 'none'; };
      editForm.onsubmit = function(ev) {
        ev.preventDefault();
        const formData = new FormData(editForm);
        if (name === 'Meeting Card') {
          // Rebuild HTML
          let html = '<div style="padding:18px 24px;background:#eef6ff;border-radius:8px;border:2px solid #003ab8;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:8px;">';
          if (formData.get('title')) html += `<div style='font-size:1.2em;font-weight:700;color:#003ab8;margin-bottom:6px;'>${formData.get('title')}</div>`;
          if (formData.get('location')) html += `<div style='color:#003ab8;'><b>[Location]</b> ${formData.get('location')}</div>`;
          if (formData.get('uod')) html += `<div style='font-weight:600;color:#FFCD00;'><b>[UOD]</b> ${formData.get('uod')}</div>`;
          if (formData.get('details')) html += `<div style='margin:8px 0;color:#333;'><b>[Details]</b> ${formData.get('details')}</div>`;
          if (formData.get('cadets')) html += `<div style='font-weight:600;color:#003ab8;'><b>[Cadets]</b> ${formData.get('cadets')}</div>`;
          if (formData.get('primary')) html += `<div style='color:#003ab8;'><b>[Primary AM]</b> ${formData.get('primary')}</div>`;
          html += '</div>';
          block.querySelector('.block-content').innerHTML = html;
        } else {
          block.querySelector('.block-content').innerHTML = formData.get('html');
        }
        setTimeout(() => { editModal.style.display = 'none'; }, 10);
      };
    }

    // (Old inline editing removed; now handled by modal)

    // Drag-and-drop to add template to preview
    bacePreview.addEventListener('dragover', e => {
      e.preventDefault();
      bacePreview.classList.add('drag-over');
    });
    bacePreview.addEventListener('dragleave', e => {
      bacePreview.classList.remove('drag-over');
    });
    bacePreview.addEventListener('drop', async e => {
      e.preventDefault();
      bacePreview.classList.remove('drag-over');
      const tplFile = e.dataTransfer.getData('text/template');
      if (tplFile) {
        const tpl = templates.find(t => t.file === tplFile);
        if (tpl) {
          const html = await fetchTemplate(tpl.file);
          addBlock(html, tpl.name);
        }
      }
    });
    // Export to Bace.html
    document.getElementById('saveBtn').onclick = function() {
      // Update preview instantly (no download yet)
      Array.from(bacePreview.children).forEach(block => {
        // Remove editing state if any
        block.classList.remove('editing');
        const contentDiv = block.querySelector('.block-content');
        contentDiv.querySelectorAll('[contenteditable]').forEach(el => {
          el.removeAttribute('contenteditable');
          if (el.tagName === 'A') el.onclick = null;
        });
        if (block.querySelector('.add-signup-btn')) {
          block.querySelectorAll('.add-signup-btn').forEach(btn => btn.remove());
        }
      });
      // Download as Bace.html
      let html = '';
      Array.from(bacePreview.children).forEach(block => {
        const content = block.querySelector('.block-content').innerHTML;
        html += `\n${content}\n`;
      });
      const blob = new Blob([
        '<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>Bace.html</title>\n<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">\n</head>\n<body style="font-family: Ubuntu, Arial, sans-serif; background: #f4f8ff; padding: 32px;">',
        html,
        '</body>\n</html>'
      ], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'Bace.html';
      a.click();
    };
  </script>
</body>
</html>
