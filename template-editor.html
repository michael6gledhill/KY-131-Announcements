<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Template Drag-and-Drop Editor</title>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Ubuntu', Arial, sans-serif; background: #f4f8ff; margin: 0; padding: 0; }
    .container { max-width: 1200px; margin: 32px auto; background: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.10); padding: 32px; }
    h1 { color: #001489; text-align: center; }
    .templates-list, .bace-preview { min-height: 100px; padding: 16px; border-radius: 8px; margin-bottom: 24px; }
    .templates-list { background: #f9f9f9; border: 2px dashed #003ab8; display: flex; flex-wrap: wrap; gap: 16px; }
    .template-item { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px 18px; cursor: grab; min-width: 180px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: box-shadow 0.2s; }
    .template-item:active { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
    .bace-preview { background: #f5faff; border: 2px solid #FFCD00; min-height: 200px; }
    .block { background: #fff; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 12px; padding: 16px; position: relative; cursor: move; }
    .block .edit-btn, .block .delete-btn { position: absolute; top: 8px; font-size: 0.9em; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; }
    .block .edit-btn { right: 48px; background: #003ab8; color: #fff; }
    .block .delete-btn { right: 8px; background: #BA0C2F; color: #fff; }
    .block.editing { border: 2px solid #003ab8; background: #eef6ff; }
    .save-btn { background: #003ab8; color: #fff; font-weight: 700; padding: 12px 32px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; display: block; margin: 32px auto 0 auto; }
    textarea.block-edit { width: 100%; height: 120px; font-size: 1em; font-family: monospace; border-radius: 6px; border: 1px solid #bbb; margin-top: 8px; }
    .drag-over { border: 2px dashed #28a745 !important; background: #eaffea !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Drag & Drop Template Editor</h1>
    <div class="css-editor" id="formattingSection">
      <h2 style="margin-top:0;color:#001489;">Global Formatting</h2>
      <label>Primary Color: <input type="color" id="primaryColor" value="#001489"></label>
      <label>Accent Color: <input type="color" id="accentColor" value="#FFCD00"></label>
      <label>Font Family:
        <select id="fontFamily">
          <option value="Ubuntu,Arial,sans-serif">Ubuntu, Arial, sans-serif</option>
          <option value="Arial,sans-serif">Arial, sans-serif</option>
          <option value="Georgia,serif">Georgia, serif</option>
        </select>
      </label>
      <button id="applyFormatting" style="margin-left:16px;background:#003ab8;color:#fff;font-weight:700;padding:6px 18px;border:none;border-radius:6px;cursor:pointer;">Apply</button>
    </div>
    <h2>Available Templates</h2>
    <div class="templates-list" id="templatesList"></div>
    <div id="templatePreviewPopup" style="display:none;position:absolute;z-index:1000;background:#fff;border:2px solid #003ab8;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.12);padding:18px;max-width:420px;min-width:220px;"></div>
    <h2>Bace.html Preview (Drag templates here)</h2>
    <div class="bace-preview" id="bacePreview"></div>
    <button class="save-btn" id="saveBtn">Export to Bace.html</button>
  </div>
  <script>
        // Quick meeting block generator
        function parseMeetingText(text) {
          // Improved parser for labeled meeting format
          const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
          let data = {
            title: '',
            subtitle: '',
            location: '',
            uod: '',
            details: '',
            cadets: '',
            primary: ''
          };
          let current = '';
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (/^\[Location\]/i.test(line)) { current = 'location'; continue; }
            if (/^\[UOD\]/i.test(line)) { current = 'uod'; continue; }
            if (/^\[Details\]/i.test(line)) { current = 'details'; continue; }
            if (/^\[Cadets\]/i.test(line)) { current = 'cadets'; continue; }
            if (/^\[Primary AM\]/i.test(line)) { current = 'primary'; continue; }
            if (!data.title) { data.title = line; continue; }
            if (!data.subtitle) { data.subtitle = line; continue; }
            if (current && data[current] === '') { data[current] = line; continue; }
          }
          let html = '<div style="padding:18px 24px;background:#eef6ff;border-radius:8px;border:2px solid #003ab8;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:8px;">';
          if (data.title) html += `<div style='font-size:1.2em;font-weight:700;color:#003ab8;margin-bottom:6px;'>${data.title}</div>`;
          if (data.subtitle) html += `<div style='font-weight:600;color:#001489;'>${data.subtitle}</div>`;
          if (data.location) html += `<div style='color:#003ab8;'><b>Location:</b> ${data.location}</div>`;
          if (data.uod) html += `<div style='font-weight:600;color:#FFCD00;'><b>UOD:</b> ${data.uod}</div>`;
          if (data.details) html += `<div style='margin:8px 0;color:#333;'><b>Details:</b> ${data.details}</div>`;
          if (data.cadets) html += `<div style='font-weight:600;color:#003ab8;'><b>Cadets:</b> ${data.cadets}</div>`;
          if (data.primary) html += `<div style='color:#003ab8;'><b>Primary AM:</b> ${data.primary}</div>`;
          html += '</div>';
          return html;
        }

        // Paste handler for meeting info
        document.addEventListener('paste', function(e) {
          const text = (e.clipboardData || window.clipboardData).getData('text');
          // Detect meeting format (starts with 'Meeting #')
          if (/^Meeting #/i.test(text)) {
            e.preventDefault();
            addBlock(parseMeetingText(text), 'Meeting Card');
          }
        });
    // List of templates (update if you add more)
    const templates = [
      { name: 'Meeting Card', file: 'templates/template3.html' },
      { name: 'No Meeting Highlight', file: 'templates/template4.html' },
      { name: 'General Info Card', file: 'templates/template5.html' },
      { name: 'Opportunity Card', file: 'templates/template6.html' },
      { name: 'Wing Announcement Card', file: 'templates/template7.html' },
      { name: 'Open Signups', file: 'templates/template-signup.html' },
      { name: 'Divider: Upcoming Squadron Meetings', file: 'templates/template-divider-meetings.html' },
      { name: 'Divider: General Squadron Information', file: 'templates/template-divider-general.html' },
      { name: 'Divider: Ongoing Opportunities', file: 'templates/template-divider-opportunities.html' },
      { name: 'Divider: Wing & Higher Command Announcements', file: 'templates/template-divider-wing.html' },
      { name: 'Divider: Footer', file: 'templates/template-divider-footer.html' }
    ];
    // Load template HTML via fetch
    async function fetchTemplate(file) {
      const res = await fetch(file);
      return await res.text();
    }
    // Render template list
    const templatesList = document.getElementById('templatesList');
    const templatePreviewPopup = document.getElementById('templatePreviewPopup');
    templates.forEach((tpl, idx) => {
      const div = document.createElement('div');
      div.className = 'template-item';
      // Preview on hover
      div.addEventListener('mouseenter', async e => {
        const html = await fetchTemplate(tpl.file);
        templatePreviewPopup.innerHTML = `<div style='font-weight:600;color:#003ab8;margin-bottom:8px;'>${tpl.name}</div>` + html;
        templatePreviewPopup.style.display = 'block';
        const rect = div.getBoundingClientRect();
        templatePreviewPopup.style.top = (window.scrollY + rect.bottom + 8) + 'px';
        templatePreviewPopup.style.left = (window.scrollX + rect.left) + 'px';
      });
      div.addEventListener('mouseleave', e => {
        templatePreviewPopup.style.display = 'none';
      });
      // Drag to add block
      div.draggable = true;
      div.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/template', tpl.file);
        div.classList.add('dragging');
      });
      div.addEventListener('dragend', e => {
        div.classList.remove('dragging');
      });
      // Click to add block
      div.addEventListener('click', async () => {
        const html = await fetchTemplate(tpl.file);
        addBlock(html, tpl.name);
      });
      templatesList.appendChild(div);
      div.textContent = tpl.name;
    });

    // Add block to preview
    const bacePreview = document.getElementById('bacePreview');
    function addBlock(html, name) {
      const block = document.createElement('div');
      block.className = 'block';
      block.innerHTML = `<span style="font-weight:600;color:#003ab8;">${name}</span><button class="edit-btn">Edit</button><button class="delete-btn">Delete</button><div class="block-content">${html}</div>`;

      // Enable drag-and-drop reorder
      block.draggable = true;
      block.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/block', 'block');
        e.dataTransfer.setData('block-idx', Array.from(bacePreview.children).indexOf(block));
        block.classList.add('dragging');
      });
      block.addEventListener('dragend', e => { block.classList.remove('dragging'); });
      block.addEventListener('dragover', e => { e.preventDefault(); block.classList.add('drag-over'); });
      block.addEventListener('dragleave', e => { block.classList.remove('drag-over'); });
      block.addEventListener('drop', e => {
        e.preventDefault();
        block.classList.remove('drag-over');
        const dragging = document.querySelector('.block.dragging');
        if (dragging && dragging !== block) {
          if (e.offsetY < block.offsetHeight / 2) {
            bacePreview.insertBefore(dragging, block);
          } else {
            bacePreview.insertBefore(dragging, block.nextSibling);
          }
        }
      });

      // Delete button
      block.querySelector('.delete-btn').onclick = function() {
        block.remove();
      };

      // Edit button: enable contenteditable for all text and links
      block.querySelector('.edit-btn').onclick = function() {
        enableBlockEditing(block, name);
      };

      // Click-to-edit: allow clicking any text or link to edit directly
      block.querySelector('.block-content').addEventListener('click', function(e) {
        if (!block.classList.contains('editing')) {
          enableBlockEditing(block, name);
        }
      });

      bacePreview.appendChild(block);
    }

    // Enable editing for a block
    function enableBlockEditing(block, name) {
      if (block.classList.contains('editing')) return;
      block.classList.add('editing');
      const contentDiv = block.querySelector('.block-content');
      // Make all text and links editable
      contentDiv.querySelectorAll('*').forEach(el => {
        if (el.tagName === 'A') {
          el.setAttribute('contenteditable', 'true');
          el.onclick = e => e.preventDefault();
        } else if (el.childNodes.length === 0 || (el.childNodes.length === 1 && el.childNodes[0].nodeType === 3)) {
          el.setAttribute('contenteditable', 'true');
        }
      });
      // For signup template, allow multiple signups
      if (name === 'Open Signups') {
        let signupList = contentDiv.querySelector('div[style*="display: flex"]');
        if (signupList) {
          // Remove old add buttons
          signupList.querySelectorAll('.add-signup-btn').forEach(btn => btn.remove());
          // Add button to add new signup
          const addBtn = document.createElement('button');
          addBtn.textContent = 'Add Signup';
          addBtn.className = 'add-signup-btn';
          addBtn.style = 'margin:8px 0 0 0;background:#28a745;color:#fff;font-weight:600;padding:6px 18px;border:none;border-radius:6px;cursor:pointer;';
          addBtn.onclick = function() {
            const newSignup = document.createElement('a');
            newSignup.href = '#';
            newSignup.textContent = 'New Signup';
            newSignup.setAttribute('contenteditable', 'true');
            newSignup.style = 'display:inline-block;padding:12px 24px;font-size:0.95em;font-weight:600;text-decoration:none;border-radius:6px;cursor:pointer;border:none;text-align:center;font-family:Ubuntu,Arial,sans-serif;background:linear-gradient(135deg,#28a745 0%,#5be584 100%);color:#fff;box-shadow:0 4px 12px rgba(40,167,69,0.2);margin-right:10px;';
            newSignup.onclick = e => e.preventDefault();
            // Remove on right-click
            newSignup.addEventListener('contextmenu', function(ev) {
              ev.preventDefault();
              newSignup.remove();
            });
            signupList.insertBefore(newSignup, addBtn);
          };
          signupList.appendChild(addBtn);
        }
      }
      // Save button
      let saveBtn = contentDiv.querySelector('.save-edit');
      if (!saveBtn) {
        saveBtn = document.createElement('button');
        saveBtn.className = 'edit-btn save-edit';
        saveBtn.textContent = 'Save';
        contentDiv.appendChild(saveBtn);
      }
      saveBtn.onclick = function() {
        // Remove contenteditable and addBtn
        contentDiv.querySelectorAll('[contenteditable]').forEach(el => {
          el.removeAttribute('contenteditable');
          if (el.tagName === 'A') el.onclick = null;
        });
        if (name === 'Open Signups') {
          let signupList = contentDiv.querySelector('div[style*="display: flex"]');
          if (signupList) {
            signupList.querySelectorAll('.add-signup-btn').forEach(btn => btn.remove());
          }
        }
        block.classList.remove('editing');
      };
    }

    // Drag-and-drop to add template to preview
    bacePreview.addEventListener('dragover', e => {
      e.preventDefault();
      bacePreview.classList.add('drag-over');
    });
    bacePreview.addEventListener('dragleave', e => {
      bacePreview.classList.remove('drag-over');
    });
    bacePreview.addEventListener('drop', async e => {
      e.preventDefault();
      bacePreview.classList.remove('drag-over');
      const tplFile = e.dataTransfer.getData('text/template');
      if (tplFile) {
        const tpl = templates.find(t => t.file === tplFile);
        if (tpl) {
          const html = await fetchTemplate(tpl.file);
          addBlock(html, tpl.name);
        }
      }
    });
    // Export to Bace.html
    document.getElementById('saveBtn').onclick = function() {
      // Update preview instantly (no download yet)
      Array.from(bacePreview.children).forEach(block => {
        // Remove editing state if any
        block.classList.remove('editing');
        const contentDiv = block.querySelector('.block-content');
        contentDiv.querySelectorAll('[contenteditable]').forEach(el => {
          el.removeAttribute('contenteditable');
          if (el.tagName === 'A') el.onclick = null;
        });
        if (block.querySelector('.add-signup-btn')) {
          block.querySelectorAll('.add-signup-btn').forEach(btn => btn.remove());
        }
      });
      // Download as Bace.html
      let html = '';
      Array.from(bacePreview.children).forEach(block => {
        const content = block.querySelector('.block-content').innerHTML;
        html += `\n${content}\n`;
      });
      const blob = new Blob([
        '<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>Bace.html</title>\n<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">\n</head>\n<body style="font-family: Ubuntu, Arial, sans-serif; background: #f4f8ff; padding: 32px;">',
        html,
        '</body>\n</html>'
      ], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'Bace.html';
      a.click();
    };
  </script>
</body>
</html>
